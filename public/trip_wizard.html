<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Viajes</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #333;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select,
        input,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        .results-info {
            background: #e7f1ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Nuevo Viaje</h1>

        <!-- Step 1: Ciudad de Operación -->
        <div id="step1" class="step active">
            <h2>1. Ubicación</h2>
            <div class="form-group">
                <label>Ciudad / Sede de Operación</label>
                <input type="text" id="sedeInput" placeholder="Ej: Bogota, Cali, Centro Logístico..."
                    oninput="checkStep1()">
                <small class="hint">Escribe la ciudad o nombre de la sede para buscar vehículos disponibles.</small>
            </div>

            <div class="actions">
                <div></div> <!-- Spacer -->
                <button class="btn" id="btnStep1" onclick="performSearch()" disabled>Buscar Recursos</button>
            </div>
        </div>

        <!-- Step 2: Detalles -->
        <div id="step2" class="step">
            <h2>2. Configuración del Viaje</h2>

            <div id="resultsInfo" class="results-info"></div>

            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="fechaViaje">
            </div>

            <div class="form-group">
                <label>Vehículo (Filtrado por ubicación)</label>
                <select id="vehiculoSelect">
                    <option value="">Seleccione vehículo...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ruta</label>
                <select id="rutaSelect">
                    <!-- Se cargan todas las rutas o se filtran si es posible -->
                    <option value="">Seleccione ruta (opcional)...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Conductor</label>
                <select id="conductorSelect">
                    <option value="">Seleccione conductor...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Auxiliar</label>
                <select id="auxiliarSelect">
                    <option value="">Seleccione auxiliar (opcional)...</option>
                </select>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="prevStep(1)">Atrás y Buscar de Nuevo</button>
                <button class="btn" onclick="nextStep(3)">Revisar</button>
            </div>
        </div>

        <!-- Step 3: Resumen -->
        <div id="step3" class="step">
            <h2>3. Resumen</h2>
            <div id="resumenContent"></div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="prevStep(2)">Atrás</button>
                <button class="btn" onclick="submitTrip()">Confirmar (Guardar Local)</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let appState = {
            sedeInfo: "",
            allVehicles: [],
            filteredVehicles: []
        };

        function checkStep1() {
            const val = document.getElementById('sedeInput').value;
            document.getElementById('btnStep1').disabled = val.trim().length < 3;
        }

        async function performSearch() {
            const query = document.getElementById('sedeInput').value.toLowerCase().trim();
            const btn = document.getElementById('btnStep1');
            btn.textContent = "Buscando...";
            btn.disabled = true;

            try {
                // 1. Fetch Vehicles
                const vRes = await fetch(`${API_URL}/vehiculos`);
                if (!vRes.ok) throw new Error("Error obteniendo vehículos");
                const vehicles = await vRes.json();

                // 2. Filter Client-Side
                // Match against city name or cost center name
                const filtered = vehicles.filter(v => {
                    const city = (v.city && typeof v.city === 'object' ? v.city.name : v.city) || "";
                    const cc = (v.costCenter && v.costCenter.name) || "";

                    return (city.toLowerCase().includes(query) || cc.toLowerCase().includes(query));
                });

                appState.filteredVehicles = filtered;
                appState.sedeInfo = query;

                // 3. Load Dropdown
                const vSelect = document.getElementById('vehiculoSelect');
                vSelect.innerHTML = '<option value="">Seleccione vehículo...</option>';
                if (filtered.length === 0) {
                    vSelect.innerHTML = '<option value="">No se encontraron vehículos en "' + query + '"</option>';
                } else {
                    filtered.forEach(v => {
                        const city = (v.city && typeof v.city === 'object' ? v.city.name : v.city) || "Sin ciudad";
                        const opt = document.createElement('option');
                        opt.value = v.id;
                        opt.textContent = `${v.placa} - ${v.tipo || 'Vehiculo'} (${city})`;
                        vSelect.appendChild(opt);
                    });
                }

                // Update Info Banner
                const info = document.getElementById('resultsInfo');
                info.style.display = 'block';
                info.textContent = `${filtered.length} vehículos encontrados para "${query}". Mostrando coincidencias.`;

                // 4. Load other resources (simpler logic for now, load all)
                loadOtherResources();

                // Go to next step
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');

            } catch (e) {
                console.error(e);
                alert("Error buscando recursos: " + e.message);
            } finally {
                btn.textContent = "Buscar Recursos";
                btn.disabled = false;
            }
        }

        async function loadOtherResources() {
            // Load Routes (Global List as fallback)
            try {
                const rRes = await fetch(`${API_URL}/rutas`);
                const routes = await rRes.json();
                const rSelect = document.getElementById('rutaSelect');
                rSelect.innerHTML = '<option value="">Seleccione ruta...</option>';
                routes.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = `${r.codigo} - ${r.nombre}`;
                    rSelect.appendChild(opt);
                });
            } catch (e) { console.warn("Fallo rutas", e); }

            // Load Staff
            try {
                const pRes = await fetch(`${API_URL}/personal`);
                const people = await pRes.json();
                const dSelect = document.getElementById('conductorSelect');
                const aSelect = document.getElementById('auxiliarSelect');
                dSelect.innerHTML = '<option value="">Seleccione conductor...</option>';
                aSelect.innerHTML = '<option value="">Seleccione auxiliar...</option>';

                people.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.nombre;
                    if (p.rol === 'conductor' || !p.rol) dSelect.appendChild(opt.cloneNode(true));
                    aSelect.appendChild(opt);
                });
            } catch (e) { console.warn("Fallo personal", e); }
        }

        function nextStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            if (step === 3) renderSummary();
        }

        function prevStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        function renderSummary() {
            const getTxt = (id) => {
                const el = document.getElementById(id);
                return el.options[el.selectedIndex]?.text || '(No seleccionado)';
            };

            const html = `
            <p><strong>Sede / Ciudad:</strong> ${appState.sedeInfo}</p>
            <p><strong>Fecha:</strong> ${document.getElementById('fechaViaje').value}</p>
            <hr>
            <p><strong>Vehículo:</strong> ${getTxt('vehiculoSelect')}</p>
            <p><strong>Ruta:</strong> ${getTxt('rutaSelect')}</p>
            <p><strong>Conductor:</strong> ${getTxt('conductorSelect')}</p>
            <p><strong>Auxiliar:</strong> ${getTxt('auxiliarSelect')}</p>
        `;
            document.getElementById('resumenContent').innerHTML = html;
        }

        async function submitTrip() {
            const data = {
                fecha: document.getElementById('fechaViaje').value,
                cliente_id: 0, // Placeholder
                sede_id: 0, // Placeholder
                detalles: [{
                    ruta_id: document.getElementById('rutaSelect').value || 0,
                    vehiculo_id: document.getElementById('vehiculoSelect').value,
                    conductor_id: document.getElementById('conductorSelect').value,
                    auxiliar_id: document.getElementById('auxiliarSelect').value,
                    notas: "Manual creation via Wizard"
                }]
            };

            try {
                const res = await fetch(`${API_URL}/api/trips`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert("Diaje guardado exitosamente en base de datos local!");
                    location.reload();
                } else {
                    const err = await res.json();
                    alert("Error guardando: " + (err.detail || "Desconocido"));
                }
            } catch (e) {
                alert("Error de conexión al guardar.");
            }
        }

        // Init
        document.getElementById('fechaViaje').valueAsDate = new Date();
    </script>

</body>

</html>